---
layout: post
title: docker로 개발환경 설정하기
categories: dailynote
tags: dev_environment
---

## 개발환경 설정에 대한 고민을 날려줄 한방

원래는 로컬에 개발환경을 설치하고 버전관리자와 패키지관리자로 가상환경을 만들어 관리하려고 했다. 하지만.. 사용하려는 언어는 Ruby, Python, Javascript, C++, C#, Go 등 엄청 많았고 이 모든 언어에 대해 버전관리자를 설치하고 패키지 관리자를 설치해 관리할 엄두가 나지 않았다.

하지만 이 모든 것을 해결할 한방은 이미 있었다. 나만 모르고 있었다.

> 바로 Docker를 사용해서 개발환경을 만드는 것..

Docker 란 무엇인가..? 실무자가 아니면 잘 모를 수 있다. 사실 완벽히 설명하기도 애매하다. 최신기술이기 때문이다.(나온지 10년이 됐지만) 아직 학교에서 도커를 배우거나 쓰지도 않아 한국인들 중에 아는 사람은 개발자말고는 별로 없을 것 같다.

나도 완벽히 이해하지는 못했지만 최대한 간단하게 설명해보자면

Docker 출현 이전까지는 vmware나 virtualbox 같은 가상머신 툴을 활용하여 한 운영체제 내부에서 여러 개의 운영체제를, 여러 개의 다른 운영체제를 동시에 사용할 수 있었다. 하지만 이런방식은 물론 좋았지만 심각한 오버헤드를 유발했다. 제일 바깥 OS 내부의 가상 OS에서 각각의 커널이 돌아갔기 때문이다. 커널은 컴퓨터 자원을 필연적으로 잡아먹으며, 자원을 프로그램에 할당하고 관리한다.

하지만 Docker는 그동안 사용되어 오던 가상머신의 패러다임을 부숴버렸다. 바로 한 가상화 마다 커널을 새로 실행하지 않고 제일 바깥 OS의 커널을 공유해서 사용하면서 환경은 완벽히 격리시켜버리기로 한 것이다.

이게 어떻게 가능하지..? 라는 생각이 들 수 있지만 docker는 이것을 해낸다. 자원만 쏙쏙 빼먹으면서 환경은 논리적으로 완벽히 격리되어 있는 것 이거 완전 우리mz 세대 아닌가 하는 생각이 든다.

여튼 docker는 처음에 나왔을 때 보통 서버에서 실행되는 app을 효과적으로 관리하기 위해 쓰였다. 하지만 docker가 널리 퍼지고 알려지면서 사람들은 이걸 개발환경에 적용할 생각을 하기 시작한다. 각각의 도커 컨테이너(vm이라고 생각하면됨)에 언어 컴파일러를 설치하면 이거 완전 가상환경 아닌가? 하는 생각이 드는것이다.

> 도커를 알기 전까지의 개발환경 (python 기준)
> 맥북을 초기화했다!
> 1. xcode를 설치한다
> 2. homebrew를 설치한다
> 3. pyenv를 설치한다.
> 4. pyenv로 파이썬을 설치한다.
> 5. pipenv로 가상환경을 만들고, 패키지를 설치한다.
> 6. 또 다른 프로젝트에 가상환경을 만들고, 패키지를 설치한다.
> 7. 다른 팀원은? 1~6을 반복한다.

하하 너무 과정이 많지 않은가? 사용하는 언어가 늘어나면 이 과정을 n번 반복해야한다.

> 하지만 이걸 한방에 해주는 asdf 가 있잖아요!

라고 생각할 뻔 했지만 사용법을 익히기에 러닝커브가 너무 크고 복잡하고 버그가 많았다..

## docker는 신이다

docker는 신이 맞다.

docker로 개발환경을 만들면 프로젝트별로 독립된 이미지를 개발자가 스스로 만들 수 있다.
이는 결국 pyenv와 같은 버전관리자, pipenv와 같은 패키지, 가상환경 관리자 조차 설치할 필요, 사용법을 알 필요조차 없다는 것이며 내 운영체제 shell의 path가 더럽혀질 필요조차 없고 .zshrc에 설정을 추가할 필요조차 없다. 운영체제가 그냥 빈 깡통이어도 완벽한 개발환경에서 일관성을 가지고 개발할 수 있으며, 오픈소스로 배포를 할 때도 빌드오류를 0에 가깝게 만들 수 있다. 모든 과정이 Dockerfile의 명세를 작성하는 것 한방으로 압축된다.

우리는 흔히 개발 의존성을 따로 텍스트 파일로 만들어서 컴퓨터를 바꾸거나 초기화하거나 다른 팀원이 설치해야 할 때 일일이 커맨드를 입력해서 설치한다. 그리고 버전관리자 패키지 관리자 조차도 너무나 파편화 되어 있고 오픈소스 프로그램이라 유지보수가 일관적이거나 사용이 일관적이지 않다.

이 모든것을 docker를 사용함으로써 한방에 해결할 수 있다.

하지만 단점도 있다. 세상에 완벽한 것은 없는법

> docker는 traditional한 vm보다 자원을 덜 먹지만 그래도 여전히 무겁다.
> 그리고 로컬에서 개발하고 실행하는 것보다 빌드속도가 느릴 수 있다.

도커 이미지 자체가 저장공간을 소모한다. 최소 100mb이상 먹는 것 같다. 그리고 컨테이너를 실행하면 ram도 많이 먹는다. 아무래도 격리된 프로세스라도 최소한 리눅스 운영체제를 구현해야 하니 말이다. 그리고 image-specific 하게 속도차이가 나는 경우도 있다. (특히 alphaine linux는 파이썬을 빌드할 때 느리다고 한다)

> 그래도 이정도 문제는 하드웨어에 돈을 투자하면 해결이된다 ^ㅡㅡ^

### M$의 변화..

그리고 M$ 가 vscode 에 dev containers 라는 익스텐션을 올해 초에 공식적으로 릴리즈하면서 이제는 개발에 모든 full feature를 완벽하게 docker를 통해 구현할 수 있게 되었다. MS 는 이 확장을 통해 기초적인 도커 템플릿을 제공하며, devcontainers.json 설정파일을 좀 더 vscode에 최적화되게 docker 개발환경을 활용할 수 있게 해준다. 이 확장을 깔면, Dockerfile을 통해 도커를 빌드하고 remote 로 접속할 수 있으며, 바로 실행된 컨테이너의 shell에 접근해서 추가적으로 패키지를 깔던지 원하는 그 무엇이라도 할 수 있게 해준다. 그리고 이미 만들어진 개발 이미지들을 제공하여 초기에 docker의 복잡한 설정에 대해 잘 알지 못해도 금방 숙련되게 만들어줬다.

M$ 라고 욕을 많이 먹었지만 요즘의 행보는 정말 대담한 것 같다. 어떤면에서는 jetbrains보다 더 좋은것 같다. 그래서 나도 갈아탔다.

docker를 사용하면 패키지 관리자를 사용 못하나?? 할 수 있지만 무려 python과 conda가 깔려있는 템플릿 이미지를 제공중이다. 다른 여러 db프로그램과의 조합도 제공되고 있으며 심지어 버전관리자를 깔아서 도커 내부에서 파이썬 버전관리를 할 수 있다. (하지만 이렇게 변태적으로 쓰는 경우는 잘 없을 것 같다.)

어차피 각각의 다른 프로젝트마다 다른 도커 이미지를 사용하면 되기 때문이다.
동일한 프로젝트에서 다른 버전의 프로그래밍 언어로 상시 교체한다..? 나는 아직까지 이런 경우를 보지 못했다. 하지만 현업 현장에서는 이런 괴랄한 경우가 일어날 수도 있을 수 있을 것 같다.

결국 도커 이미지 자체가 하나의 가상환경인 것이다. Dockerfile에 모든 것을 명시할 수 있다. 언어의 버전, 가상운영체제의 유저를 설정할 수도 있으며, 어떤 패키지를 깔지 텍스트 파일에 명시하고 Build하여 이미지를 만들면, 이미지에는 해당 패키지들이 설치된 채로 fix 된다. 개발중에 새로 패키지를 설치한다면, 이미지의 인스턴스인 컨테이너를 삭제하지 않는 이상 계속 유지되지만 컨테이너를 삭제하고 재실행하면 모든 패키지는 초기화된다. 이를 막기 위해 dev containers 확장은 간단하게 버튼하나로 이미지를 rebuild 할 수 있는 기능을 제공한다. 이를 통해 도커 이미지를 업데이트하고 일관적인 개발환경을 유지할 수 있다.

내일부터는 아마 이 도커를 이용해서 개발환경을 설정하는 방법을 다룰 것이다..

예시는 python으로 들었지만 각 언어마다 설정법과 가능한 정도, 한계가 다르다. 디버깅 설정도 해야하고 할 것이 많다.